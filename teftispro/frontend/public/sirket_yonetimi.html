<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şirket Yönetimi - TeftişPro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/public/styles.css">
    <script src="/public/layout.js"></script>
</head>

<body>
    <main>
        <div class="p-4 lg:p-8 tp-animate-in">
            <div class="flex items-center justify-between mb-6">
                <div><h2 class="text-2xl font-bold" style="color:var(--text-primary);">Şirket Yönetimi</h2><p class="text-sm mt-1" style="color:var(--text-muted);">Şirketleri ekleyin ve yönetin</p></div>
                <button onclick="openModal()" class="tp-btn tp-btn-primary"><span class="material-symbols-outlined">add</span><span class="hidden sm:inline">Yeni Şirket</span></button>
            </div>
            <div class="tp-card rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="tp-table">
                        <thead><tr><th>Şirket Adı</th><th>Bölge Sayısı</th><th>Şube Sayısı</th><th>Firma Sahibi</th><th>İşlemler</th></tr></thead>
                        <tbody id="companiesTable"></tbody>
                    </table>
                </div>
                <div id="loadingState" class="p-8 text-center"><div class="tp-spinner mx-auto"></div></div>
            </div>
        </div>
    </main>

    <div id="modal" class="tp-modal-overlay">
        <div class="tp-modal max-w-md">
            <div class="tp-modal-header"><h3 id="modalTitle" class="tp-modal-title">Yeni Şirket</h3><button onclick="closeModal()" class="tp-btn-ghost"><span class="material-symbols-outlined">close</span></button></div>
            <form id="companyForm" class="space-y-4">
                <div><label class="tp-label">Şirket Adı</label><input type="text" id="companyName" required class="tp-input" placeholder="ABC Holding A.Ş."></div>
                <div><label class="tp-label">Firma Sahibi (Opsiyonel)</label><select id="companyOwner" class="tp-input tp-select"><option value="">Seçin...</option></select></div>
                <button type="submit" class="w-full tp-btn tp-btn-primary py-3">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080';
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/public/login.html';
        // Sayfa bazlı rol kontrolü
        if (LAYOUT.getUserRole() !== 'admin') {
            window.location.href = '/public/kontrol_paneli.html';
        }
        let companies = [], editId = null;

        async function load() {
            try {
                const [compRes, userRes] = await Promise.all([
                    fetch(`${API_URL}/companies`, { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch(`${API_URL}/users?role=firma_sahibi`, { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                companies = await compRes.json();
                const owners = await userRes.json();
                const s = document.getElementById('companyOwner');
                owners.forEach(u => s.innerHTML += `<option value="${u.id}">${u.email}</option>`);
                render();
            } catch (e) { console.error(e); }
            document.getElementById('loadingState').classList.add('hidden');
        }

        function render() {
            document.getElementById('companiesTable').innerHTML = companies.map(c => `
                <tr>
                    <td><div class="flex items-center gap-3"><div class="tp-stat-icon tp-icon-green"><span class="material-symbols-outlined">business</span></div><span class="font-medium" style="color:var(--text-primary);">${c.name}</span></div></td>
                    <td>${c.regions?.length || 0}</td>
                    <td>${c.branches?.length || 0}</td>
                    <td>${c.owner?.email || '-'}</td>
                    <td><button onclick="deleteCompany(${c.id})" class="tp-btn-ghost" style="color:var(--text-muted);" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'"><span class="material-symbols-outlined">delete</span></button></td>
                </tr>
            `).join('');
        }

        function openModal() { document.getElementById('modal').classList.add('active'); }
        function closeModal() { document.getElementById('modal').classList.remove('active'); document.getElementById('companyForm').reset(); }

        document.getElementById('companyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('companyName').value, ownerId = document.getElementById('companyOwner').value;
            try { await fetch(`${API_URL}/companies`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name, ownerId: ownerId ? parseInt(ownerId) : undefined }) }); closeModal(); load(); } catch (e) { alert('Hata: ' + e.message); }
        });

        async function deleteCompany(id) { if (!confirm('Şirketi silmek istediğinize emin misiniz?')) return; await fetch(`${API_URL}/companies/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); load(); }

        load();
    </script>
</body>

</html>
