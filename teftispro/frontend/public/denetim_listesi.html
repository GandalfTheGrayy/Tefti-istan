<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Denetim Listesi - TeftişPro</title>
    <meta name="description" content="Tüm denetimleri görüntüleyin ve yönetin">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/public/styles.css">
    <script src="/public/layout.js"></script>
</head>

<body>
    <main>
        <div class="p-4 lg:p-8 tp-animate-in">
            <!-- Page Header -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold" style="color:var(--text-primary);">Denetimler</h2>
                    <p class="text-sm mt-1" style="color:var(--text-muted);">Tüm denetimleri görüntüleyin ve yönetin</p>
                </div>
                <button onclick="createNewAudit()" id="newAuditBtn" class="hidden tp-btn tp-btn-primary">
                    <span class="material-symbols-outlined">add</span>
                    <span class="hidden sm:inline">Yeni Denetim</span>
                </button>
            </div>

            <!-- Filters -->
            <div class="tp-card rounded-2xl p-4 mb-6">
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 min-w-[200px]">
                        <div class="relative">
                            <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2"
                                style="color:var(--text-muted);">search</span>
                            <input type="text" id="searchInput" placeholder="Denetim ara..." class="tp-input"
                                style="padding-left:3rem;">
                        </div>
                    </div>
                    <select id="statusFilter" class="tp-input tp-select" style="width:auto;">
                        <option value="">Tüm Durumlar</option>
                        <option value="draft">Taslak</option>
                        <option value="submitted">Gönderildi</option>
                        <option value="approved">Onaylandı</option>
                        <option value="revision_requested">Revizyon</option>
                    </select>
                    <button onclick="exportCSV()" class="tp-btn tp-btn-secondary">
                        <span class="material-symbols-outlined">download</span>
                        CSV
                    </button>
                </div>
            </div>

            <!-- Table -->
            <div class="tp-card rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="tp-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" class="accent-emerald-500 rounded"></th>
                                <th>ID</th>
                                <th>Başlık / Lokasyon</th>
                                <th>Durum</th>
                                <th>Sorumlu</th>
                                <th>Puan</th>
                                <th>Tarih</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="auditsTableBody"></tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden tp-empty-state">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <p>Henüz denetim bulunmuyor</p>
                </div>

                <div id="loadingState" class="p-12 text-center">
                    <div class="tp-spinner mx-auto"></div>
                    <p class="mt-4" style="color:var(--text-muted);">Yükleniyor...</p>
                </div>

                <div id="pagination" class="hidden flex items-center justify-between p-4"
                    style="border-top:1px solid var(--border-color);">
                    <p class="text-sm" style="color:var(--text-muted);">
                        <span id="showingFrom">1</span>-<span id="showingTo">10</span> / <span id="totalCount">0</span>
                        denetim
                    </p>
                    <div class="flex gap-2">
                        <button onclick="prevPage()" class="tp-btn tp-btn-secondary" id="prevBtn" disabled>
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <button onclick="nextPage()" class="tp-btn tp-btn-secondary" id="nextBtn">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Modal -->
    <div id="deleteModal" class="tp-modal-overlay">
        <div class="tp-modal max-w-md">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full tp-icon-red flex items-center justify-center">
                    <span class="material-symbols-outlined">warning</span>
                </div>
                <div>
                    <h3 class="tp-modal-title">Denetimi Sil</h3>
                    <p class="text-sm" style="color:var(--text-muted);">Bu işlem geri alınamaz</p>
                </div>
            </div>
            <p class="mb-6" style="color:var(--text-secondary);">Bu denetimi silmek istediğinizden emin misiniz?</p>
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 tp-btn tp-btn-secondary">İptal</button>
                <button onclick="confirmDelete()" class="flex-1 tp-btn tp-btn-danger"
                    style="background:rgba(239,68,68,0.1);">Sil</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const userRole = typeof user.role === 'object' ? user.role.name : user.role;

        if (!token) window.location.href = '/public/login.html';

        let allAudits = [], filteredAudits = [], currentPage = 1;
        const perPage = 10;
        let deleteAuditId = null;

        if (['admin', 'planlamacı'].includes(userRole)) {
            document.getElementById('newAuditBtn').classList.remove('hidden');
        }

        async function loadAudits() {
            try {
                const response = await fetch(`${API_URL}/audits`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) {
                    allAudits = await response.json();
                    filteredAudits = [...allAudits];
                    renderAudits();
                }
            } catch (error) { console.error('Load audits error:', error); }
            document.getElementById('loadingState').classList.add('hidden');
        }

        function renderAudits() {
            const tbody = document.getElementById('auditsTableBody');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');

            if (filteredAudits.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            pagination.classList.remove('hidden');

            const totalPages = Math.ceil(filteredAudits.length / perPage);
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageAudits = filteredAudits.slice(start, end);

            document.getElementById('showingFrom').textContent = start + 1;
            document.getElementById('showingTo').textContent = Math.min(end, filteredAudits.length);
            document.getElementById('totalCount').textContent = filteredAudits.length;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;

            tbody.innerHTML = pageAudits.map(audit => `
                <tr>
                    <td><input type="checkbox" class="audit-checkbox accent-emerald-500 rounded" data-id="${audit.id}"></td>
                    <td style="color:var(--text-muted);">#${audit.id}</td>
                    <td>
                        <p class="font-medium" style="color:var(--text-primary);">${audit.title || 'Denetim #' + audit.id}</p>
                        <p class="text-xs" style="color:var(--text-muted);">${audit.branch?.name || ''} ${audit.branch?.company?.name ? '- ' + audit.branch.company.name : ''}</p>
                    </td>
                    <td><span class="tp-badge tp-badge-${audit.status}">${getStatusName(audit.status)}</span></td>
                    <td>${audit.user?.email?.split('@')[0] || '-'}</td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="tp-progress-bar"><div class="tp-progress-bar-fill" style="width:${audit.score?.percent || 0}%"></div></div>
                            <span class="text-sm ${getScoreColor(audit.score?.percent)}">${audit.score?.percent || 0}%</span>
                        </div>
                    </td>
                    <td class="text-sm">${formatDate(audit.createdAt)}</td>
                    <td>
                        <div class="flex items-center gap-1">
                            <a href="${getAuditLink(audit)}" class="tp-btn-ghost" style="color:var(--color-accent);" title="Görüntüle">
                                <span class="material-symbols-outlined text-xl">visibility</span>
                            </a>
                            ${userRole === 'admin' ? `
                                <button onclick="openDeleteModal(${audit.id})" class="tp-btn-ghost" style="color:var(--text-muted);" title="Sil"
                                        onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'">
                                    <span class="material-symbols-outlined text-xl">delete</span>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusName(s) {
            return { 'draft': 'Taslak', 'submitted': 'Gönderildi', 'approved': 'Onaylandı', 'rejected': 'Reddedildi', 'revision_requested': 'Revizyon', 'pending': 'Atandı' }[s] || s;
        }
        function getScoreColor(p) { return p >= 80 ? 'tp-score-high' : p >= 60 ? 'tp-score-mid' : 'tp-score-low'; }
        function getAuditLink(a) {
            if (['draft', 'revision_requested'].includes(a.status)) return `/public/denetim_cevaplama.html?id=${a.id}`;
            return `/public/denetim_inceleme.html?id=${a.id}`;
        }
        function formatDate(d) { return new Date(d).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }); }

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            filteredAudits = allAudits.filter(a => {
                const matchSearch = !search || (a.title || '').toLowerCase().includes(search) || (a.branch?.name || '').toLowerCase().includes(search) || (a.user?.email || '').toLowerCase().includes(search);
                const matchStatus = !status || a.status === status;
                return matchSearch && matchStatus;
            });
            currentPage = 1;
            renderAudits();
        }

        function prevPage() { if (currentPage > 1) { currentPage--; renderAudits(); } }
        function nextPage() { const t = Math.ceil(filteredAudits.length / perPage); if (currentPage < t) { currentPage++; renderAudits(); } }

        async function createNewAudit() {
            try {
                const r = await fetch(`${API_URL}/audits`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                if (r.ok) { const a = await r.json(); window.location.href = `/public/denetim_cevaplama.html?id=${a.id}`; }
            } catch (e) { alert('Denetim oluşturulurken bir hata oluştu'); }
        }

        function openDeleteModal(id) { deleteAuditId = id; document.getElementById('deleteModal').classList.add('active'); }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); deleteAuditId = null; }
        async function confirmDelete() {
            if (!deleteAuditId) return;
            try { await fetch(`${API_URL}/audits/${deleteAuditId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); allAudits = allAudits.filter(a => a.id !== deleteAuditId); applyFilters(); closeDeleteModal(); } catch (e) { alert('Silme işlemi başarısız'); }
        }

        function exportCSV() {
            const headers = ['ID', 'Başlık', 'Durum', 'Sorumlu', 'Puan', 'Tarih', 'Şube', 'Şirket'];
            const rows = filteredAudits.map(a => [a.id, a.title || 'Denetim #' + a.id, getStatusName(a.status), a.user?.email || '', (a.score?.percent || 0) + '%', formatDate(a.createdAt), a.branch?.name || '', a.branch?.company?.name || '']);
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `denetimler_${new Date().toISOString().split('T')[0]}.csv`; a.click();
        }

        document.getElementById('selectAll').addEventListener('change', (e) => { document.querySelectorAll('.audit-checkbox').forEach(cb => cb.checked = e.target.checked); });

        loadAudits();
    </script>
</body>

</html>