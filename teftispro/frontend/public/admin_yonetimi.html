<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kullanıcı Yönetimi - TeftişPro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/public/styles.css">
    <script src="/public/layout.js"></script>
</head>

<body>
    <main>
        <div class="p-4 lg:p-8 tp-animate-in">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold" style="color:var(--text-primary);">Kullanıcı Yönetimi</h2>
                    <p class="text-sm mt-1" style="color:var(--text-muted);">Sistem kullanıcılarını yönetin</p>
                </div>
                <button onclick="openAddModal()" class="tp-btn tp-btn-primary">
                    <span class="material-symbols-outlined">person_add</span>
                    <span class="hidden sm:inline">Yeni Kullanıcı</span>
                </button>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                <div class="tp-stat-card text-center">
                    <p class="text-2xl font-bold" style="color:var(--text-primary);" id="totalUsers">0</p>
                    <p class="text-sm" style="color:var(--text-muted);">Toplam</p>
                </div>
                <div class="tp-stat-card text-center">
                    <p class="text-2xl font-bold" style="color:#3b82f6;" id="adminCount">0</p>
                    <p class="text-sm" style="color:var(--text-muted);">Admin</p>
                </div>
                <div class="tp-stat-card text-center">
                    <p class="text-2xl font-bold" style="color:#10b981;" id="fieldCount">0</p>
                    <p class="text-sm" style="color:var(--text-muted);">Saha</p>
                </div>
                <div class="tp-stat-card text-center">
                    <p class="text-2xl font-bold" style="color:#f59e0b;" id="planlamaciCount">0</p>
                    <p class="text-sm" style="color:var(--text-muted);">Planlamacı</p>
                </div>
                <div class="tp-stat-card text-center">
                    <p class="text-2xl font-bold" style="color:#8b5cf6;" id="reviewerCount">0</p>
                    <p class="text-sm" style="color:var(--text-muted);">Onaylayan</p>
                </div>
            </div>

            <!-- Search -->
            <div class="tp-card rounded-2xl p-4 mb-6">
                <div class="relative">
                    <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2"
                        style="color:var(--text-muted);">search</span>
                    <input type="text" id="searchInput" placeholder="Kullanıcı ara..." class="tp-input"
                        style="padding-left:3rem;">
                </div>
            </div>

            <!-- Table -->
            <div class="tp-card rounded-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="tp-table">
                        <thead>
                            <tr>
                                <th>Kullanıcı</th>
                                <th>Rol</th>
                                <th>Kayıt Tarihi</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
                <div id="loadingState" class="p-12 text-center">
                    <div class="tp-spinner mx-auto"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="userModal" class="tp-modal-overlay">
        <div class="tp-modal max-w-md">
            <div class="tp-modal-header">
                <h3 id="modalTitle" class="tp-modal-title">Yeni Kullanıcı</h3><button onclick="closeModal()"
                    class="tp-btn-ghost"><span class="material-symbols-outlined">close</span></button>
            </div>
            <form id="userForm" class="space-y-4">
                <div><label class="tp-label">E-posta</label><input type="email" id="userEmail" required class="tp-input"
                        placeholder="ornek@email.com"></div>
                <div><label class="tp-label">Şifre</label><input type="password" id="userPassword" class="tp-input"
                        placeholder="••••••••">
                    <p class="text-xs mt-1" style="color:var(--text-muted);">Düzenlerken boş bırakırsanız şifre değişmez
                    </p>
                </div>
                <div><label class="tp-label">Rol</label><select id="userRole" required class="tp-input tp-select">
                        <option value="field">Saha Denetçisi</option>
                        <option value="planlamacı">Planlamacı</option>
                        <option value="gözden_geçiren">Gözden Geçiren</option>
                        <option value="firma_sahibi">Firma Sahibi</option>
                        <option value="sube_kullanici">Şube Kullanıcı</option>
                        <option value="admin">Admin</option>
                    </select></div>
                <button type="submit" class="w-full tp-btn tp-btn-primary py-3">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="tp-modal-overlay">
        <div class="tp-modal max-w-md">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-full tp-icon-red flex items-center justify-center"><span
                        class="material-symbols-outlined">warning</span></div>
                <div>
                    <h3 class="tp-modal-title">Kullanıcıyı Sil</h3>
                    <p class="text-sm" style="color:var(--text-muted);">Bu işlem geri alınamaz</p>
                </div>
            </div>
            <p class="mb-6" style="color:var(--text-secondary);">Bu kullanıcıyı silmek istediğinizden emin misiniz?</p>
            <div class="flex gap-3"><button onclick="closeDeleteModal()"
                    class="flex-1 tp-btn tp-btn-secondary">İptal</button><button onclick="confirmDelete()"
                    class="flex-1 tp-btn" style="background:#ef4444;color:#fff;">Sil</button></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const token = localStorage.getItem('token');
        const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        const currentRole = typeof currentUser.role === 'object' ? currentUser.role.name : currentUser.role;
        if (!token || currentRole !== 'admin') window.location.href = '/public/kontrol_paneli.html';

        let users = [], editUserId = null, deleteUserId = null;

        async function loadUsers() {
            try { const r = await fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${token}` } }); if (r.ok) { users = await r.json(); renderUsers(); updateStats(); } } catch (e) { console.error(e); }
            document.getElementById('loadingState').classList.add('hidden');
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = users.filter(u => u.email.toLowerCase().includes(search));
            tbody.innerHTML = filtered.map(u => `
                <tr>
                    <td><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:var(--bg-input);"><span class="material-symbols-outlined" style="color:var(--text-muted);">person</span></div><div><p class="font-medium" style="color:var(--text-primary);">${u.email}</p><p class="text-xs" style="color:var(--text-muted);">ID: ${u.id}</p></div></div></td>
                    <td><span class="tp-badge tp-role-${u.role}">${getRoleDisplayName(u.role)}</span></td>
                    <td class="text-sm">${formatDate(u.createdAt)}</td>
                    <td><div class="flex items-center gap-1"><button onclick="openEditModal(${u.id})" class="tp-btn-ghost" title="Düzenle"><span class="material-symbols-outlined">edit</span></button>${u.id !== currentUser.id ? `<button onclick="openDeleteModal(${u.id})" class="tp-btn-ghost" style="color:var(--text-muted);" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'" title="Sil"><span class="material-symbols-outlined">delete</span></button>` : ''}</div></td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('adminCount').textContent = users.filter(u => u.role === 'admin').length;
            document.getElementById('fieldCount').textContent = users.filter(u => u.role === 'field').length;
            document.getElementById('planlamaciCount').textContent = users.filter(u => u.role === 'planlamacı').length;
            document.getElementById('reviewerCount').textContent = users.filter(u => u.role === 'gözden_geçiren').length;
        }

        function getRoleDisplayName(r) { return { 'admin': 'Admin', 'planlamacı': 'Planlamacı', 'field': 'Saha', 'gözden_geçiren': 'Onaylayan', 'firma_sahibi': 'Firma Sahibi', 'sube_kullanici': 'Şube Kullanıcı' }[r] || r; }
        function formatDate(d) { return new Date(d).toLocaleDateString('tr-TR'); }

        document.getElementById('searchInput').addEventListener('input', renderUsers);

        function openAddModal() { editUserId = null; document.getElementById('modalTitle').textContent = 'Yeni Kullanıcı'; document.getElementById('userForm').reset(); document.getElementById('userPassword').required = true; document.getElementById('userModal').classList.add('active'); }
        function openEditModal(id) { editUserId = id; const u = users.find(x => x.id === id); if (!u) return; document.getElementById('modalTitle').textContent = 'Kullanıcı Düzenle'; document.getElementById('userEmail').value = u.email; document.getElementById('userPassword').value = ''; document.getElementById('userPassword').required = false; document.getElementById('userRole').value = u.role; document.getElementById('userModal').classList.add('active'); }
        function closeModal() { document.getElementById('userModal').classList.remove('active'); editUserId = null; }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('userEmail').value, password = document.getElementById('userPassword').value, role = document.getElementById('userRole').value;
            try {
                if (editUserId) { alert('Güncelleme özelliği henüz aktif değil'); }
                else { const r = await fetch(`${API_URL}/users`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, role }) }); if (!r.ok) { const d = await r.json(); throw new Error(d.error); } }
                closeModal(); loadUsers();
            } catch (e) { alert(e.message); }
        });

        function openDeleteModal(id) { deleteUserId = id; document.getElementById('deleteModal').classList.add('active'); }
        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); deleteUserId = null; }
        async function confirmDelete() { if (!deleteUserId) return; try { await fetch(`${API_URL}/users/${deleteUserId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } }); closeDeleteModal(); loadUsers(); } catch (e) { alert('Silme başarısız'); } }

        loadUsers();
    </script>
</body>

</html>